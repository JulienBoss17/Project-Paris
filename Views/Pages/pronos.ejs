<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronostics | Dashboard</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <%- include('../Partials/navbar') %>

    <div class="container">
        <% if(annonces && annonces.length > 0) { %>
            <% annonces.forEach(annonce => { %>
                <div class="annonce">
                    <h1>Derni√®re annonce</h1>
                    <div class="annonce-content">
                        <h3><%= annonce.titre %></h3>
                        <p><%= annonce.description %></p>
                        <div class="text-muted" style="font-size: 0.85rem; margin-top: 1rem;">
                            <span>üìÖ <%= new Date(annonce.dateAnnonce).toLocaleDateString("fr-FR") %> √† 
                            <%= new Date(annonce.dateAnnonce).toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" }) %></span>
                            <br>
                            <span>üë§ Par <strong><%= annonce.userId.prenom %> <%= annonce.userId.nom %></strong></span>
                        </div>
                    </div>
                </div>    
            <% }) %>
        <% } %>
    </div>
    
    <div class="container">
        <h2 class="text-center">Tableau de Bord</h2>
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Total Pronos</span>
                <span class="stat-value"><%= totalPronostics %></span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Gagn√©s</span>
                <span class="stat-value" style="color: var(--success);"><%= pronosticsGagnes %></span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Perdus</span>
                <span class="stat-value" style="color: var(--danger);"><%= pronosticsPerdus %></span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Taux de r√©ussite</span>
                <span class="stat-value"><%= ratio %>%</span>
            </div>
        </div>
    </div>

    <div class="container text-center">
        <div id="MyClockDisplay" class="clock"></div>
        <h2 style="margin-top: 1rem;">‚è≥ Pronostics en attente</h2>
    
        <div class="container">  
            <% if(pronosEnAttente.length === 0) { %>
                <p class="text-center">Aucun pronostic en attente.</p>
            <% } %>

            <% pronosEnAttente.forEach(prono => { %>
                <div class="match card">
                    <div class="match-info">
                        <span class="badge badge-info"><%= prono.typePari %></span>
                        <p>Cote Totale : <strong><%= prono.cote || 'N/A' %></strong></p>
                    </div>

                    <div class="match-details">
                        <% prono.matchs.forEach(match => { %>
                            <div class="match-item">
                                <strong><%= match.equipeDomicile %> vs <%= match.equipeExterieur %></strong>
                                <div class="match-meta">
                                    <span><%= match.typePrediction %> : <%= match.prediction %></span>
                                    <span>Cote : <%= match.cote %></span>
                                </div>
                            </div>
                        <% }); %>
                    </div>

                    <% if (user?.role === "admin") { %>
                        <div class="admin-actions">
                            <form action="/<%= prono._id %>/statut" method="POST" class="form-inline">
                                <select name="statut" class="select-statut">
                                    <option value="En Attente" <%= prono.statut === "En Attente" ? "selected" : "" %>>En attente</option>
                                    <option value="Gagn√©" <%= prono.statut === "Gagn√©" ? "selected" : "" %>>Gagn√©</option>
                                    <option value="Perdu" <%= prono.statut === "Perdu" ? "selected" : "" %>>Perdu</option>
                                </select>
                                <button type="submit" class="btn-sm">Mettre √† jour</button>
                            </form>
                        </div>
                    <% } %>
                </div>
            <% }); %>
        </div>
    </div>

    
    <div class="container">
        <h2 class="text-center">‚úÖ Pronostics termin√©s</h2>
        <% pronosTermines.forEach(prono => { %>
            <div class="match card">
                <div class="justify-between align-center mb-1">
                    <span class="<%= prono.statut === 'Gagn√©' ? 'statuty' : 'statutn' %>">
                        <%= prono.statut %>
                    </span>
                    <small class="text-muted"><%= new Date(prono.createdAt).toLocaleDateString("fr-FR") %></small>
                </div>

                <div class="match-grid">
                    <div class="match-list">
                        <% prono.matchs.forEach(match => { %>
                            <div class="mb-1">
                                <strong><%= match.equipeDomicile %> - <%= match.equipeExterieur %></strong><br>
                                <small><%= match.prediction %> (Cote: <%= match.cote %>)</small>
                            </div>
                        <% }); %>
                    </div>
                    <div class="match-summary text-center">
                        <span class="text-muted">Cote finale</span>
                        <div class="cote-finale"><%= prono.cote %></div>
                    </div>
                </div>

                <div class="commentaire-section">
                    <h4>Commentaires</h4>
                    <div class="commentaires-list">
                        <% if (prono.commentaires.length === 0) { %>
                            <p class="text-muted small">Aucun commentaire.</p>
                        <% } else { %>
                            <% prono.commentaires.forEach(commentaire => { %>
                                <div class="commentaire-item">
                                    <div class="commentaire-header">
                                        <strong><%= commentaire.auteur %></strong>
                                        <small><%= new Date(commentaire.date).toLocaleDateString() %></small>
                                    </div>
                                    <p><%= commentaire.contenu %></p>
                                    <% if (user?.role === "admin") { %>
                                        <form action="/<%= prono._id %>/commentaire/<%= commentaire._id %>?_method=DELETE" method="POST">
                                            <button type="submit" class="text-danger small btn-link">Supprimer</button>
                                        </form>
                                    <% } %>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>

                    <% if (user) { %>
                        <form action="/<%= prono._id %>/commentaire" method="POST" class="commentaire-form">
                            <input type="hidden" name="auteur" value="<%= user.prenom %>">
                            <textarea name="contenu" placeholder="Ajouter un commentaire (max 50 car.)..." maxlength="50" required></textarea>
                            <button type="submit" class="btn-primary">Envoyer</button>
                        </form>      
                    <% } %>
                </div>
            </div>
        <% }); %>
    </div>

    <%- include('../Partials/footer') %>

    <script>
        // Gestion du scroll apr√®s soumission
        document.addEventListener("DOMContentLoaded", () => {
            if (sessionStorage.getItem("scrollPosition")) {
                window.scrollTo(0, sessionStorage.getItem("scrollPosition"));
                sessionStorage.removeItem("scrollPosition");
            }
            document.querySelectorAll("form").forEach(form => {
                form.addEventListener("submit", () => {
                    sessionStorage.setItem("scrollPosition", window.scrollY);
                });
            });
        });

        // Horloge temps r√©el
        function showTime(){
            const date = new Date();
            let h = date.getHours();
            let m = date.getMinutes();
            let s = date.getSeconds();
            
            h = (h < 10) ? "0" + h : h;
            m = (m < 10) ? "0" + m : m;
            s = (s < 10) ? "0" + s : s;
            
            const time = `${h}:${m}:${s}`;
            document.getElementById("MyClockDisplay").textContent = time;
            setTimeout(showTime, 1000);
        }
        showTime();

        // Raccourci Entr√©e pour commentaires
        document.querySelectorAll(".commentaire-form textarea").forEach(area => {
            area.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && !e.shiftKey) { 
                    e.preventDefault();
                    e.target.closest("form").submit();
                }
            });
        });
    </script>
</body>
</html>